<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แจ้งท่อประปาแตกรั่ว</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 for alert messages -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/2.23.1/sdk.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f0f4f8;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .liff-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="p-4">

    <!-- Loading Overlay -->
    <div id="liff-loading" class="liff-loading">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <div id="app" class="max-w-md mx-auto bg-white p-6 rounded-xl card hidden">
        <h1 class="text-2xl font-bold text-center text-blue-700 mb-6">แจ้งท่อประปาแตกรั่ว</h1>
        <p class="text-sm text-gray-500 text-center mb-6">ข้อมูล LINE ID ของคุณจะถูกบันทึกโดยอัตโนมัติเพื่อส่งข้อความยืนยัน</p>

        <form id="report-form" class="space-y-4">
            
            <!-- Hidden Input for LINE User ID -->
            <input type="hidden" id="lineUserId" name="lineUserId">
            
            <div>
                <label for="reporterName" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล ผู้แจ้ง <span class="text-red-500">*</span></label>
                <input type="text" id="reporterName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border">
            </div>

            <div>
                <label for="contactNumber" class="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ติดต่อ <span class="text-red-500">*</span></label>
                <input type="tel" id="contactNumber" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border">
            </div>
            
            <div>
                <label for="leakLocation" class="block text-sm font-medium text-gray-700">สถานที่ท่อประปารั่ว (ชื่อถนน/ซอย/หมู่บ้าน) <span class="text-red-500">*</span></label>
                <textarea id="leakLocation" rows="3" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border"></textarea>
            </div>
            
            <div>
                <label for="leakDetail" class="block text-sm font-medium text-gray-700">รายละเอียดของเหตุการณ์ (เช่น รั่วแรง/ซึม/ท่อแตกบริเวณใด)</label>
                <textarea id="leakDetail" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border"></textarea>
            </div>

            <div class="bg-blue-50 p-3 rounded-lg">
                <label for="mapLink" class="block text-sm font-medium text-blue-700">ลิงก์ Google Maps / Latitude, Longitude (ถ้ามี)</label>
                <input type="text" id="mapLink" placeholder="เช่น https://maps.app.goo.gl/..." class="mt-1 block w-full rounded-lg border-blue-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border">
            </div>

            <button type="submit" id="submitBtn" class="w-full py-3 mt-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-lg">
                ส่งข้อมูลแจ้งเหตุ
            </button>
        </form>
    </div>

<script>
    // **สำคัญ**: URL นี้จะถูกแทนที่โดย Apps Script เมื่อมีการ Deploy Web App
    // ถ้าคุณทดสอบในเครื่อง ให้แทนที่ด้วย URL ที่ได้จากการ Deploy Web App ของ Code.gs
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhiZHYxPJa0nPOyJ1X6YgCZov1zLffxA9uyOkwLXNA5cDxcg6EsVuEtRIM4HZ9g497/exec'; 

    const form = document.getElementById('report-form');
    const submitBtn = document.getElementById('submitBtn');
    const loadingOverlay = document.getElementById('liff-loading');
    const appContainer = document.getElementById('app');
    const lineUserIdInput = document.getElementById('lineUserId');

    async function initializeLiff() {
        try {
            // 1. Initialize LIFF
            await liff.init({ liffId: "1657790891-jb82nQBm" }); // **เปลี่ยน YOUR_LIFF_ID ด้วย LIFF ID จริงของคุณ**

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            // 2. Get User Profile and ID
            const profile = await liff.getProfile();
            lineUserIdInput.value = profile.userId;
            
            loadingOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');

        } catch (err) {
            console.error('LIFF Initialization failed', err);
            loadingOverlay.classList.add('hidden');
            Swal.fire({
                icon: 'error',
                title: 'LIFF Error',
                text: 'ไม่สามารถโหลดแอปพลิเคชันได้ กรุณาเปิดผ่านแอปพลิเคชัน LINE',
                allowOutsideClick: false
            });
        }
    }

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        if (!lineUserIdInput.value) {
            Swal.fire('Error', 'ไม่พบ LINE User ID กรุณาลองเปิดใหม่', 'error');
            return;
        }

        submitBtn.disabled = true;
        loadingOverlay.classList.remove('hidden');

        try {
            const data = {
                lineUserId: lineUserIdInput.value,
                reporterName: document.getElementById('reporterName').value,
                contactNumber: document.getElementById('contactNumber').value,
                leakLocation: document.getElementById('leakLocation').value,
                leakDetail: document.getElementById('leakDetail').value,
                mapLink: document.getElementById('mapLink').value
            };

            const response = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            loadingOverlay.classList.add('hidden');  

            if (result.status === 'success') {
                await Swal.fire({
                    title: 'แจ้งเหตุสำเร็จ!',
                    html: `ส่งข้อมูลแจ้งเหตุเรียบร้อย<br>รหัสแจ้งเหตุ: <strong>${result.reportId}</strong><br>คุณจะได้รับข้อความยืนยันใน LINE`,
                    icon: 'success',
                    confirmButtonText: 'ปิดหน้าต่าง',
                    allowOutsideClick: false
                });
                liff.closeWindow();
            } else {
                throw new Error(result.message || 'การส่งข้อมูลล้มเหลว');
            }

        } catch (error) {
            loadingOverlay.classList.add('hidden');
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถส่งข้อมูลได้ กรุณาลองใหม่ภายหลัง',
            });
            submitBtn.disabled = false;
        } 
    });

    // Start LIFF initialization when the page loads
    initializeLiff();
</script>
</body>
</html>
